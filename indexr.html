<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç¶²é ç•ªèŒ„é˜è¨ˆæ™‚å™¨</title>
  <style>
    :root{
      --bg-light: #FFF9DB; /* æ·ºé»ƒè‰²èƒŒæ™¯ */
      --bg-deep-coffee: #4E342E; /* æ·±å’–å•¡ */
      --tomato-color: #FF4500; /* æ©˜ç´…è‰² (ç•ªèŒ„) */
      --tomato-dark: #E63C00;
      --display-bg: rgba(255,255,255,0.12);
      --control-bg: rgba(255,255,255,0.9);
      --control-text: #222;
    }

    html,body{
      height:100%;
      margin:0;
      padding:0;
      background: var(--bg-light); /* é è¨­æ·ºé»ƒè‰² */
      font-family: "Noto Sans TC", "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* å®¹å™¨ */
    .container{
      width:520px;
      max-width:95vw;
      text-align:center;
    }

    /* ç•ªèŒ„é˜æœ¬é«” 500x500 */
    .tomato{
      width:500px;
      height:500px;
      margin:0 auto 18px;
      position:relative;
      border-radius:50%;
      background: radial-gradient(circle at 30% 20%, #FF7A3A 0%, var(--tomato-color) 40%, var(--tomato-dark) 100%);
      box-shadow: 0 12px 30px rgba(0,0,0,0.25), inset 0 -18px 40px rgba(0,0,0,0.12);
      overflow:visible;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* ç•ªèŒ„æŸ„ */
    .stem{
      position:absolute;
      top:-34px;
      left:50%;
      transform:translateX(-50%);
      width:120px;
      height:70px;
      border-radius:20px;
      background: linear-gradient(180deg, #2E7D32, #1B5E20);
      box-shadow: 0 6px 12px rgba(0,0,0,0.25);
    }
    .stem::before{
      /* å°è‘‰å­ */
      content:"";
      position:absolute;
      width:40px;
      height:24px;
      border-radius: 16px;
      left:6px;
      top:-18px;
      transform:rotate(-22deg);
      background: linear-gradient(180deg,#66BB6A,#2E7D32);
      box-shadow: 0 3px 6px rgba(0,0,0,0.18);
    }
    .stem::after{
      content:"";
      position:absolute;
      width:40px;
      height:24px;
      border-radius: 16px;
      right:6px;
      top:-18px;
      transform:rotate(18deg);
      background: linear-gradient(180deg,#66BB6A,#2E7D32);
      box-shadow: 0 3px 6px rgba(0,0,0,0.18);
    }

    /* é¡¯ç¤ºå€å¡Šï¼ˆé¡¯ç¤ºæ™‚é–“ï¼‰*/
    .display{
      width:320px;
      height:160px;
      border-radius:18px;
      background: var(--display-bg);
      display:flex;
      align-items:center;
      justify-content:center;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 8px 18px rgba(0,0,0,0.18);
      color: #fff;
      font-weight:500;
      font-size:64px;
      letter-spacing:4px;
      user-select:none;
    }

    /* æœ€å¾Œ3åˆ†é˜æ¨£å¼ï¼šé–ƒçˆä¸”åŠ ç²— */
    @keyframes blink {
      0%{ opacity:1; }
      50%{ opacity:0.12; }
      100%{ opacity:1; }
    }
    .urgent{
      animation: blink 1s linear infinite;
      font-weight:800;
      text-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }

    /* æ§åˆ¶åˆ— */
    .controls{
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:center;
    }
    button, .btn{
      padding:10px 16px;
      border-radius:8px;
      border: none;
      cursor:pointer;
      font-size:16px;
      color:var(--control-text);
      background: var(--control-bg);
      box-shadow: 0 6px 12px rgba(0,0,0,0.08);
    }
    button:active{ transform:translateY(1px); }
    .btn-primary{
      background: linear-gradient(180deg,#ffb37a,#ff8a3d);
      color: #2b1b10;
      font-weight:700;
      border:1px solid rgba(0,0,0,0.06);
    }

    /* è¨­å®šé¢æ¿ (æ¨¡æ…‹) */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.28);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modal{
      background: #fff;
      padding:18px;
      border-radius:12px;
      width:320px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.35);
      color:#222;
    }
    .modal h3{
      margin:0 0 8px 0;
      font-size:18px;
    }
    .inputs{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      margin:10px 0 14px;
    }
    .inputs input{
      width:92px;
      padding:8px 10px;
      font-size:18px;
      border-radius:8px;
      border:1px solid #ddd;
      text-align:center;
    }
    .modal .hint{
      font-size:12px;
      color:#666;
      margin-bottom:10px;
    }
    .small{
      font-size:13px;
      padding:8px 10px;
      border-radius:8px;
    }

    /* footer èªªæ˜ */
    .note{
      margin-top:8px;
      font-size:13px;
      color:#3b3b3b;
    }

    /* æ‰‹æ©Ÿå„ªåŒ– */
    @media (max-width:540px){
      .tomato{ width:88vw; height:88vw; }
      .display{ width:68%; height:20%; font-size:calc(18px + 6vw); }
    }

  </style>
</head>
<body>
  <div class="container" role="main" aria-labelledby="title">
    <h1 id="title" style="margin:0 0 12px;">ç•ªèŒ„é˜è¨ˆæ™‚å™¨</h1>

    <div class="tomato" id="tomato" aria-hidden="false">
      <div class="stem" aria-hidden="true"></div>

      <div class="display" id="timeDisplay" aria-live="polite" role="timer">
        25:00
      </div>

      <!-- å·¦ä¸‹æ¨™ç±¤å€: è¨­å®š æ¸…é™¤ -->
      <div style="position:absolute; left:18px; bottom:18px; display:flex; gap:8px;">
        <button id="btnSettings" class="btn" title="è¨­å®šè¨ˆæ™‚é•·åº¦">âš™ï¸ è¨­å®š</button>
        <button id="btnClear" class="btn" title="æ¸…é™¤å‰©é¤˜æ™‚é–“">ğŸ§¹ æ¸…é™¤</button>
      </div>

      <!-- å³ä¸‹: é–‹å§‹æŒ‰éˆ• -->
      <div style="position:absolute; right:18px; bottom:18px;">
        <button id="btnStart" class="btn btn-primary" title="é–‹å§‹è¨ˆæ™‚">é–‹å§‹</button>
      </div>

    </div>

    <div class="controls" aria-hidden="true" style="opacity:0.9;">
      <div style="font-size:13px; color:#333; padding:6px 10px; border-radius:8px; background:rgba(255,255,255,0.9);">
        å¯è¨­å®šæœ€é•· 99 åˆ† 59 ç§’
      </div>
    </div>

    <div class="note">
      æç¤ºï¼šæŒ‰ã€Œè¨­å®šã€å¯èª¿æ•´åˆ†/ç§’ï¼ŒæŒ‰ã€Œæ¸…é™¤ã€æœƒåœæ­¢ä¸¦æ¸…é™¤å‰©é¤˜æ™‚é–“ï¼ŒæŒ‰ã€Œé–‹å§‹ã€å•Ÿå‹•è¨ˆæ™‚ã€‚
    </div>
  </div>

  <!-- è¨­å®šæ¨¡æ…‹ -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <h3>è¨­å®šè¨ˆæ™‚é•·åº¦</h3>
      <div class="hint">è«‹è¼¸å…¥åˆ†é˜èˆ‡ç§’æ•¸ï¼Œæœ€å¤§ 99 åˆ† 59 ç§’</div>
      <div class="inputs">
        <input type="number" id="inputMin" min="0" max="99" value="25" aria-label="åˆ†é˜" />
        <input type="number" id="inputSec" min="0" max="59" value="0" aria-label="ç§’" />
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button class="small" id="modalCancel">å–æ¶ˆ</button>
        <button class="small btn-primary" id="modalSave">å„²å­˜</button>
      </div>
    </div>
  </div>

  <script>
    // DOM å…ƒä»¶
    const body = document.body;
    const display = document.getElementById('timeDisplay');
    const btnStart = document.getElementById('btnStart');
    const btnSettings = document.getElementById('btnSettings');
    const btnClear = document.getElementById('btnClear');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const inputMin = document.getElementById('inputMin');
    const inputSec = document.getElementById('inputSec');
    const modalSave = document.getElementById('modalSave');
    const modalCancel = document.getElementById('modalCancel');

    // è¨ˆæ™‚å™¨ç‹€æ…‹
    let totalSecondsSetting = 25*60; // åˆå§‹ 25 åˆ†
    let remainingSeconds = totalSecondsSetting;
    let timerInterval = null;
    let endFlashInterval = null;
    let isRunning = false;
    let isEnded = false;

    // å·¥å…·ï¼šæ ¼å¼åŒ– mm:ssï¼Œæœ€å¤§ 99:59
    function formatTime(sec){
      sec = Math.max(0, Math.floor(sec));
      const minutes = Math.floor(sec / 60);
      const seconds = sec % 60;
      const mm = String(minutes).padStart(2,'0');
      const ss = String(seconds).padStart(2,'0');
      return mm + ':' + ss;
    }

    // æ›´æ–°é¡¯ç¤ºï¼ˆåœ¨å€’æ•¸æœŸé–“é¡¯ç¤ºå‰©é¤˜æ™‚é–“ï¼‰
    function refreshDisplay(){
      display.textContent = formatTime(remainingSeconds);
      // åˆ¤å®šæœ€å¾Œ 3 åˆ†é˜ (<=180s ä¸” >0)
      if (isRunning && remainingSeconds > 0 && remainingSeconds <= 180) {
        display.classList.add('urgent');
      } else {
        display.classList.remove('urgent');
      }
    }

    // é–‹å§‹è¨ˆæ™‚
    function startTimer(){
      if (isRunning) return;
      if (remainingSeconds <= 0) {
        // å¦‚æœå‰©é¤˜æ™‚é–“ç‚º0ï¼Œè‡ªè¨­å®šå€¼é‡æ–°é–‹å§‹
        remainingSeconds = totalSecondsSetting;
      }
      if (remainingSeconds <= 0) {
        alert('è«‹å…ˆè¨­å®šå¤§æ–¼ 0 çš„æ™‚é–“ã€‚');
        return;
      }

      // é€²å…¥å€’æ•¸
      isRunning = true;
      isEnded = false;
      btnStart.textContent = 'é€²è¡Œä¸­...';
      btnStart.disabled = true;
      btnSettings.disabled = true;

      // åœæ­¢ä»»ä½•çµæŸæ™‚èƒŒæ™¯é–ƒçˆ
      stopEndFlashing();

      timerInterval = setInterval(() => {
        remainingSeconds--;
        refreshDisplay();

        if (remainingSeconds <= 0){
          // åˆ°æœŸ
          stopTimer(false);
          handleTimerEnd();
        }
      }, 1000);

      refreshDisplay();
    }

    // åœæ­¢è¨ˆæ™‚ (clearOnly: æ˜¯å¦åªæ˜¯æš«åœ/æ¸…é™¤è€Œéåˆ°æœŸ)
    function stopTimer(clearOnly=true){
      if (timerInterval){
        clearInterval(timerInterval);
        timerInterval = null;
      }
      isRunning = false;
      btnStart.textContent = 'é–‹å§‹';
      btnStart.disabled = false;
      btnSettings.disabled = false;
      if (clearOnly) {
        display.classList.remove('urgent');
      }
    }

    // åˆ°æœŸè™•ç†ï¼šèƒŒæ™¯äº¤æ›¿æ·ºé»ƒè‰² / æ·±å’–å•¡
    function handleTimerEnd(){
      isEnded = true;
      // é–‹å§‹äº¤æ›¿é¡¯ç¤ºèƒŒæ™¯è‰²
      let toggle = false;
      endFlashInterval = setInterval(() => {
        toggle = !toggle;
        body.style.background = toggle ? 'var(--bg-deep-coffee)' : 'var(--bg-light)';
      }, 600);

      // å°‡é¡¯ç¤ºæ™‚é–“è¨­ç‚º 00:00
      remainingSeconds = 0;
      refreshDisplay();

      // å…è¨±æŒ‰æ¸…é™¤ä»¥åœæ­¢é–ƒçˆ
      btnStart.disabled = false;
      btnSettings.disabled = false;
      btnStart.textContent = 'é–‹å§‹';
      isRunning = false;
    }

    // åœæ­¢åˆ°æœŸé–ƒçˆä¸¦å›å¾©æ·ºé»ƒè‰²èƒŒæ™¯
    function stopEndFlashing(){
      if (endFlashInterval){
        clearInterval(endFlashInterval);
        endFlashInterval = null;
      }
      body.style.background = 'var(--bg-light)';
    }

    // æ¸…é™¤æŒ‰éˆ•è¡Œç‚ºï¼šåœæ­¢è¨ˆæ™‚ä¸¦æ¸…é™¤å‰©é¤˜æ™‚é–“ (å›åˆ°è¨­å®šå€¼)
    function clearRemaining(){
      // åœæ­¢å®šæ™‚å™¨
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      // åœæ‰çµæŸé–ƒçˆ
      stopEndFlashing();

      isRunning = false;
      isEnded = false;

      // æ¸…é™¤å‰©é¤˜æ™‚é–“ï¼šå›åˆ°è¨­å®šå€¼ï¼Œä½†è‹¥è¨­å®šå€¼ç‚º0å‰‡é¡¯ç¤º 00:00
      remainingSeconds = totalSecondsSetting;
      refreshDisplay();

      btnStart.textContent = 'é–‹å§‹';
      btnStart.disabled = false;
      btnSettings.disabled = false;
    }

    // Modal open/close
    function openSettings(){
      // åœ¨é–‹å•Ÿæ™‚é¡¯ç¤ºç›®å‰è¨­å®šå€¼
      const mins = Math.floor(totalSecondsSetting / 60);
      const secs = totalSecondsSetting % 60;
      inputMin.value = String(mins);
      inputSec.value = String(secs);
      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden','false');
    }
    function closeSettings(){
      modalBackdrop.style.display = 'none';
      modalBackdrop.setAttribute('aria-hidden','true');
    }

    // å„²å­˜è¨­å®š
    function saveSettings(){
      let m = parseInt(inputMin.value || '0', 10);
      let s = parseInt(inputSec.value || '0', 10);
      if (isNaN(m)) m = 0;
      if (isNaN(s)) s = 0;
      // å¼·åˆ¶ç¯„åœ
      if (m < 0) m = 0;
      if (m > 99) m = 99;
      if (s < 0) s = 0;
      if (s > 59) s = 59;

      totalSecondsSetting = m*60 + s;
      // ç•¶ç›®å‰æœªåœ¨å€’æ•¸æ™‚ï¼Œé¡¯ç¤ºæ›´æ–°å¾Œçš„è¨­å®šå€¼
      if (!isRunning && !isEnded) {
        remainingSeconds = totalSecondsSetting;
      }
      refreshDisplay();
      closeSettings();
    }

    // ç¶å®šäº‹ä»¶
    btnStart.addEventListener('click', () => {
      startTimer();
    });
    btnSettings.addEventListener('click', () => {
      // è¨­å®šä¸å¯åœ¨å€’æ•¸æ™‚æ›´æ”¹ï¼ˆUIä¸Šæœƒ disabledï¼‰
      if (isRunning) return;
      openSettings();
    });
    btnClear.addEventListener('click', () => {
      clearRemaining();
    });

    modalCancel.addEventListener('click', () => closeSettings());
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) closeSettings();
    });
    modalSave.addEventListener('click', () => {
      saveSettings();
    });

    // éµç›¤å‹å–„ï¼šEnter å„²å­˜
    inputSec.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') saveSettings();
    });
    inputMin.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') saveSettings();
    });

    // åˆå§‹åŒ–é¡¯ç¤º
    remainingSeconds = totalSecondsSetting;
    refreshDisplay();

    // ç•¶è¦–çª—æˆ–é é¢å¸è¼‰æ™‚æ¸…ç† intervals
    window.addEventListener('beforeunload', () => {
      if (timerInterval) clearInterval(timerInterval);
      if (endFlashInterval) clearInterval(endFlashInterval);
    });

    // Accessibility: æŒ‰ä¸‹ç©ºç™½éµå¯ä»¥æ¸…é™¤ï¼ˆç¤ºç¯„ï¼‰
    window.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && !e.altKey && !e.ctrlKey && !e.metaKey) {
        // è‹¥ç„¦é»åœ¨è¼¸å…¥æ¡†ä¸­ä¸è¦æ””æˆª
        const active = document.activeElement;
        if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA')) return;
        e.preventDefault();
        // Space è§¸ç™¼é–‹å§‹ï¼ˆæ–¹ä¾¿è¡Œå‹•è£ç½®ï¼‰ï¼š
        if (!isRunning) startTimer();
      }
    });

  </script>
</body>
</html>
